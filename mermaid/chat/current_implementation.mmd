sequenceDiagram
    autonumber
    participant FE_A as í”„ë¡ íŠ¸ì—”ë“œ A<br/>(ì‚¬ìš©ì A)
    participant FE_B as í”„ë¡ íŠ¸ì—”ë“œ B<br/>(ì‚¬ìš©ì B)
    participant SPRING as Spring Boot<br/>(WebSocket Controller)
    participant KAFKA as Kafka Broker
    participant LISTENER as Kafka Listener<br/>(Consumer)
    participant REDIS as Redis<br/>(ì„¸ì…˜ ê´€ë¦¬)
    participant DB as MySQL<br/>(ë©”ì‹œì§€ ì €ì¥)
    participant FCM as Firebase FCM<br/>(í‘¸ì‹œ ì•Œë¦¼)

    %% ì‚¬ìš©ì B ì±„íŒ…ë°© ì…ì¥
    note over FE_B, DB: ì‚¬ìš©ì B ì±„íŒ…ë°© ì…ì¥ ê³¼ì •
    FE_B->>SPRING: POST /chat/rooms/{roomId}/enter
    SPRING->>REDIS: ì‚¬ìš©ì B ì„¸ì…˜ ë“±ë¡
    SPRING-->>FE_B: ì…ì¥ ì„±ê³µ ì‘ë‹µ
    
    FE_B->>SPRING: WebSocket ì—°ê²° (ws://localhost:8080/ws-chat)
    note right of FE_B: JWT í† í°ìœ¼ë¡œ ì¸ì¦
    SPRING-->>FE_B: WebSocket ì—°ê²° ì„±ê³µ
    
    FE_B->>SPRING: êµ¬ë… (/topic/room/{roomId})
    SPRING-->>FE_B: êµ¬ë… ì„±ê³µ

    FE_B->>SPRING: GET /chat/rooms/{roomId}/messages
    SPRING->>DB: ê¸°ì¡´ ë©”ì‹œì§€ ì¡°íšŒ
    DB-->>SPRING: ë©”ì‹œì§€ ëª©ë¡
    SPRING-->>FE_B: ë©”ì‹œì§€ ëª©ë¡ ì‘ë‹µ

    %% ì‚¬ìš©ì A ì±„íŒ…ë°© ì…ì¥ (ë™ì¼í•œ ê³¼ì •)
    note over FE_A, DB: ì‚¬ìš©ì A ì±„íŒ…ë°© ì…ì¥ ê³¼ì •
    FE_A->>SPRING: POST /chat/rooms/{roomId}/enter
    SPRING->>REDIS: ì‚¬ìš©ì A ì„¸ì…˜ ë“±ë¡
    SPRING-->>FE_A: ì…ì¥ ì„±ê³µ ì‘ë‹µ
    
    FE_A->>SPRING: WebSocket ì—°ê²°
    SPRING-->>FE_A: WebSocket ì—°ê²° ì„±ê³µ
    
    FE_A->>SPRING: êµ¬ë… (/topic/room/{roomId})
    SPRING-->>FE_A: êµ¬ë… ì„±ê³µ

    %% ì‹¤ì‹œê°„ ë©”ì‹œì§€ ì „ì†¡ (í•µì‹¬ í”Œë¡œìš°)
    note over FE_A, FCM: ğŸ”¥ ì‹¤ì‹œê°„ ë©”ì‹œì§€ ì „ì†¡ ê³¼ì • (ìƒˆë¡œ ìˆ˜ì •ëœ ë¶€ë¶„)
    FE_A->>SPRING: WebSocket ë©”ì‹œì§€ ì „ì†¡<br/>(/app/chat/room/{roomId})
    note right of FE_A: { "content": "ì•ˆë…•í•˜ì„¸ìš”!" }
    
    activate SPRING
    SPRING->>DB: ë©”ì‹œì§€ ì €ì¥ (senderId, receiverId, content)
    DB-->>SPRING: ë©”ì‹œì§€ ID ë°˜í™˜
    
    SPRING->>SPRING: ChatMessageDTO ìƒì„±
    note right of SPRING: id, chatRoomId, senderId,<br/>receiverId, content, createdAt
    
    %% ğŸ”¥ í•µì‹¬: ì‹¤ì‹œê°„ ë¸Œë¡œë“œìºìŠ¤íŠ¸ (ìƒˆë¡œ ì¶”ê°€ëœ ë¶€ë¶„)
    rect rgb(255, 200, 200)
        SPRING->>FE_A: ì‹¤ì‹œê°„ ë¸Œë¡œë“œìºìŠ¤íŠ¸<br/>(/topic/room/{roomId})
        SPRING->>FE_B: ì‹¤ì‹œê°„ ë¸Œë¡œë“œìºìŠ¤íŠ¸<br/>(/topic/room/{roomId})
        note over SPRING: messagingTemplate.convertAndSend()<br/>ë¡œ ëª¨ë“  êµ¬ë…ìì—ê²Œ ì „ì†¡
    end
    
    SPRING->>KAFKA: Kafka ë©”ì‹œì§€ ì „ì†¡ (ì„ íƒì )
    note right of SPRING: kafkaTemplate.send("chat-messages")
    
    SPRING->>SPRING: ì•Œë¦¼ ì„œë¹„ìŠ¤ í˜¸ì¶œ
    deactivate SPRING

    %% í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ë©”ì‹œì§€ ìˆ˜ì‹ 
    note over FE_A, FE_B: ì‹¤ì‹œê°„ ë©”ì‹œì§€ ìˆ˜ì‹  ì²˜ë¦¬
    FE_A-->>FE_A: ë‚´ê°€ ë³´ë‚¸ ë©”ì‹œì§€<br/>í™”ë©´ì— í‘œì‹œ
    FE_B-->>FE_B: ì‹¤ì‹œê°„ìœ¼ë¡œ ë©”ì‹œì§€<br/>í™”ë©´ì— í‘œì‹œ

    %% Kafka ë°±ê·¸ë¼ìš´ë“œ ì²˜ë¦¬ (ë¹„ë™ê¸°)
    note over KAFKA, FCM: ë°±ê·¸ë¼ìš´ë“œ ì•Œë¦¼ ì²˜ë¦¬ (ë¹„ë™ê¸°)
    KAFKA-->>LISTENER: ChatMessageDTO ìˆ˜ì‹ 
    
    activate LISTENER
    LISTENER->>REDIS: ì‚¬ìš©ì B ì˜¨ë¼ì¸ ìƒíƒœ í™•ì¸
    
    alt ì‚¬ìš©ì B ì˜¤í”„ë¼ì¸
        LISTENER->>FCM: í‘¸ì‹œ ì•Œë¦¼ ì „ì†¡
        FCM-->>FE_B: ëª¨ë°”ì¼ ì•Œë¦¼ í‘œì‹œ
    else ì‚¬ìš©ì B ì˜¨ë¼ì¸ì´ì§€ë§Œ ì±„íŒ…ë°© ë°–
        LISTENER->>FCM: ì±„íŒ…ë°© ì•Œë¦¼ ì „ì†¡
        FCM-->>FE_B: ì¸ì•± ì•Œë¦¼ í‘œì‹œ
    else ì‚¬ìš©ì B ì±„íŒ…ë°© ì•ˆ
        note right of LISTENER: ì´ë¯¸ ì‹¤ì‹œê°„ìœ¼ë¡œ ë°›ì•˜ìœ¼ë¯€ë¡œ<br/>ì¶”ê°€ ì•Œë¦¼ ë¶ˆí•„ìš”
    end
    deactivate LISTENER

    %% ë©”ì‹œì§€ ì½ìŒ ì²˜ë¦¬
    note over FE_B, DB: ë©”ì‹œì§€ ì½ìŒ ì²˜ë¦¬
    FE_B->>SPRING: PUT /chat/rooms/{roomId}/read
    SPRING->>DB: ì½ìŒ ìƒíƒœ ì—…ë°ì´íŠ¸
    SPRING-->>FE_B: ì½ìŒ ì²˜ë¦¬ ì™„ë£Œ
